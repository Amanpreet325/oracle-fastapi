<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Health FHIR API Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .button-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #007bff;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .json-response {
            margin-top: 20px;
        }
        
        .stats {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Oracle Health FHIR API Integration</h1>
        
        <div class="button-container">
            <h3>üîì Oracle Sandbox (No Login Required)</h3>
            
            <!-- Patient Search Form -->
            <div class="search-section" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                <h4>üîç Search Demo Patients</h4>
                <div class="search-inputs">
                    <input type="text" id="familyName" placeholder="Family Name (e.g., Smart, Peters)" style="margin: 5px; padding: 8px; width: 180px;">
                    <input type="text" id="givenName" placeholder="Given Name (e.g., Nancy, Timmy)" style="margin: 5px; padding: 8px; width: 180px;">
                    <select id="genderSelect" style="margin: 5px; padding: 8px;">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="unknown">Unknown</option>
                    </select>
                    <input type="number" id="countInput" placeholder="Count (default 15)" min="1" max="50" style="margin: 5px; padding: 8px; width: 120px;">
                </div>
                <button onclick="searchPatients()" style="margin: 10px; background-color: #007bff;">üîç Search Patients</button>
                <button onclick="clearSearchInputs()" style="margin: 10px; background-color: #6c757d;">Clear</button>
            </div>
            
            <!-- Quick Search Buttons -->
            <div class="quick-search" style="margin: 15px 0;">
                <h4>‚ö° Quick Searches</h4>
                <button onclick="quickSearch('male')" style="margin: 3px; background-color: #17a2b8;">üë® Male Patients</button>
                <button onclick="quickSearch('female')" style="margin: 3px; background-color: #17a2b8;">üë© Female Patients</button>
                <button onclick="quickSearchFamily('Smart')" style="margin: 3px; background-color: #17a2b8;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Smart Family</button>
                <button onclick="quickSearchGiven('Nancy')" style="margin: 3px; background-color: #17a2b8;">üë© Nancy</button>
                <button onclick="getSearchSuggestions()" style="margin: 3px; background-color: #28a745;">üí° Get Search Ideas</button>
            </div>
            
            <!-- Other Demo Data -->
            <div class="other-data" style="margin: 15px 0;">
                <h4>üìä Other Demo Data</h4>
                <button id="sandboxObsBtn" onclick="fetchSandboxObservations()">Get Demo Observations</button>
                <button id="sandboxMedsBtn" onclick="fetchSandboxMedications()">Get Demo Medications</button>
                <button id="insurancePlansBtn" onclick="fetchInsurancePlans()" style="background-color: #6f42c1;">üè• Insurance Plans</button>
                <button id="testPatientsBtn" onclick="testKnownPatients()">Test Known Patient IDs</button>
            </div>
            
            <!-- Specific Record Lookups -->
            <div class="specific-lookups" style="margin: 15px 0; padding: 15px; background-color: #e9ecef; border-radius: 5px;">
                <h4>üîç Lookup Specific Records</h4>
                <div style="margin: 10px 0;">
                    <input type="text" id="patientId" placeholder="Patient ID (e.g., 12724066)" style="margin: 5px; padding: 8px; width: 200px;">
                    <button onclick="fetchCompletePatientProfile()" style="margin: 5px; background-color: #007bff;">üë§ Complete Patient Profile</button>
                    <button onclick="fetchPatientCoverage()" style="margin: 5px; background-color: #17a2b8;">üè• Patient Insurance</button>
                </div>
                <div style="margin: 10px 0;">
                    <input type="text" id="insurancePlanId" placeholder="Insurance Plan ID (e.g., 2798233)" style="margin: 5px; padding: 8px; width: 200px;">
                    <button onclick="fetchInsurancePlanById()" style="margin: 5px; background-color: #6f42c1;">Get Insurance Plan</button>
                </div>
                <div style="margin: 10px 0;">
                    <input type="text" id="medicationRequestId" placeholder="Medication Request ID (e.g., 56770371)" style="margin: 5px; padding: 8px; width: 200px;">
                    <button onclick="fetchMedicationRequestById()" style="margin: 5px; background-color: #28a745;">Get Medication Request</button>
                </div>
            </div>
            
            <hr style="margin: 20px 0; border: 1px solid #ddd;">
            
            <h3>üîê Your Registered App (Requires Login)</h3>
            <button id="loginBtn" onclick="startLogin()">Start Authorization</button>
            <button id="fetchPatientsBtn" onclick="fetchPatients()" disabled>Fetch Patients (Your App)</button>
        </div>
        
        <div id="loading" class="loading">
            <p>Fetching patients data...</p>
        </div>
        
        <div id="message"></div>
        
        <div id="response" class="json-response"></div>
    </div>

    <script>
        let responseData = null;
        let isAuthorized = false;

        // === ORACLE SANDBOX FUNCTIONS (NO LOGIN REQUIRED) ===

        // === NEW SEARCH FUNCTIONS ===
        
        async function searchPatients() {
            const familyName = document.getElementById('familyName').value.trim();
            const givenName = document.getElementById('givenName').value.trim();
            const gender = document.getElementById('genderSelect').value;
            const count = document.getElementById('countInput').value || 15;
            
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                // Build query parameters
                const params = new URLSearchParams();
                if (familyName) params.append('family', familyName);
                if (givenName) params.append('given', givenName);
                if (gender) params.append('gender', gender);
                params.append('_count', count);
                
                const url = `/oracle-sandbox/patients?${params.toString()}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData, null, 2));
                }
                
                const data = await response.json();
                displayPatientsData(data);
                
            } catch (error) {
                console.error('Search error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Search failed: ${error.message}</div>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function quickSearch(gender) {
            const response = await fetch(`/oracle-sandbox/patients-by-gender/${gender}`);
            const data = await response.json();
            displayPatientsData(data);
        }
        
        async function quickSearchFamily(familyName) {
            const response = await fetch(`/oracle-sandbox/patients-by-family/${familyName}`);
            const data = await response.json();
            displayPatientsData(data);
        }
        
        async function quickSearchGiven(givenName) {
            const response = await fetch(`/oracle-sandbox/patients-by-given/${givenName}`);
            const data = await response.json();
            displayPatientsData(data);
        }
        
        async function getSearchSuggestions() {
            try {
                const response = await fetch('/oracle-sandbox/common-patient-searches');
                const data = await response.json();
                
                const messageDiv = document.getElementById('message');
                const responseDiv = document.getElementById('response');
                
                messageDiv.innerHTML = `<div class="success">üí° ${data.description}</div>`;
                
                let suggestionsHtml = '<h3>Search Suggestions for Oracle Sandbox:</h3>';
                suggestionsHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
                
                // Display search examples
                Object.entries(data.search_examples).forEach(([category, examples]) => {
                    suggestionsHtml += `<div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">`;
                    suggestionsHtml += `<h4>${category.replace('_', ' ').toUpperCase()}</h4>`;
                    Object.entries(examples).forEach(([name, url]) => {
                        suggestionsHtml += `<p><strong>${name}:</strong> <code>${url}</code></p>`;
                    });
                    suggestionsHtml += '</div>';
                });
                
                suggestionsHtml += '</div>';
                
                // Add notes
                suggestionsHtml += '<h4>üìã Important Notes:</h4><ul>';
                data.notes.forEach(note => {
                    suggestionsHtml += `<li>${note}</li>`;
                });
                suggestionsHtml += '</ul>';
                
                responseDiv.innerHTML = suggestionsHtml;
                
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                document.getElementById('message').innerHTML = `<div class="error">‚ùå Failed to load suggestions</div>`;
            }
        }
        
        function clearSearchInputs() {
            document.getElementById('familyName').value = '';
            document.getElementById('givenName').value = '';
            document.getElementById('genderSelect').value = '';
            document.getElementById('countInput').value = '';
        }
        
        function displayPatientsData(data) {
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Found ${data.total_found} patients</div>`;
            
            if (data.patients_summary && data.patients_summary.length > 0) {
                let patientsHtml = '<h3>Search Results:</h3>';
                data.patients_summary.forEach((patient, index) => {
                    // Format addresses
                    let addressHtml = '';
                    if (patient.formatted_addresses && patient.formatted_addresses.length > 0) {
                        addressHtml = patient.formatted_addresses.map(addr => 
                            `<li><strong>${addr.use}:</strong> ${addr.formatted_text}</li>`
                        ).join('');
                        addressHtml = `<ul>${addressHtml}</ul>`;
                    } else {
                        addressHtml = 'No address on file';
                    }
                    
                    // Format contacts
                    let contactHtml = '';
                    if (patient.formatted_contacts && patient.formatted_contacts.length > 0) {
                        contactHtml = patient.formatted_contacts.map(contact => 
                            `<li><strong>${contact.type} (${contact.use}):</strong> ${contact.value}</li>`
                        ).join('');
                        contactHtml = `<ul>${contactHtml}</ul>`;
                    } else {
                        contactHtml = 'No contact info on file';
                    }
                    
                    patientsHtml += `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                            <h4>Patient ${index + 1} - ${patient.formatted_names.join(', ') || 'Name not available'}</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                                <div>
                                    <h5>üìã Basic Info</h5>
                                    <p><strong>ID:</strong> ${patient.id}</p>
                                    <p><strong>Gender:</strong> ${patient.gender || 'Not specified'}</p>
                                    <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not specified'}</p>
                                    <p><strong>Age:</strong> ${patient.calculated_age ? patient.calculated_age + ' years' : 'Not calculated'}</p>
                                    <p><strong>Birth Year:</strong> ${patient.birth_year || 'Not available'}</p>
                                    <p><strong>Active:</strong> ${patient.active ? 'Yes' : 'No'}</p>
                                    <p><strong>Marital Status:</strong> ${patient.maritalStatus?.text || 'Not specified'}</p>
                                </div>
                                
                                <div>
                                    <h5>üìû Contact Info</h5>
                                    ${contactHtml}
                                </div>
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <h5>üè† Address Information</h5>
                                ${addressHtml}
                            </div>
                            
                            <div style="margin: 10px 0;">
                                <button onclick="fetchCompletePatientProfileById('${patient.id}')" 
                                        style="background-color: #17a2b8; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">
                                    üîç Get Complete Profile + Insurance
                                </button>
                            </div>
                        </div>
                    `;
                });
                responseDiv.innerHTML = patientsHtml;
            } else {
                responseDiv.innerHTML = '<p>No patients found with the specified criteria.</p>';
            }
        }

        async function fetchSandboxPatients() {
            // Use default search (Smart family)
            await quickSearchFamily('Smart');
        }

        async function fetchSandboxPatientsOld() {
            const sandboxBtn = document.getElementById('sandboxPatientsBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                sandboxBtn.disabled = true;
                sandboxBtn.textContent = 'Fetching Demo Patients...';
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch('/oracle-sandbox/patients');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - ${data.description}</div>`;
                
                // Display patients
                let patientsHtml = '<h3>Demo Patients from Oracle Sandbox:</h3>';
                data.patients_summary.forEach((patient, index) => {
                    patientsHtml += `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                            <h4>Demo Patient ${index + 1}</h4>
                            <p><strong>ID:</strong> ${patient.id}</p>
                            <p><strong>Gender:</strong> ${patient.gender || 'Not specified'}</p>
                            <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not specified'}</p>
                            <p><strong>Active:</strong> ${patient.active ? 'Yes' : 'No'}</p>
                            <p><strong>Names:</strong></p>
                            <ul>
                                ${patient.names.map(name => `
                                    <li>Family: ${name.family || 'N/A'}, Given: ${(name.given || []).join(', ') || 'N/A'} ${name.use ? `(${name.use})` : ''}</li>
                                `).join('')}
                            </ul>
                            ${patient.telecom && patient.telecom.length > 0 ? `<p><strong>Contact:</strong> ${JSON.stringify(patient.telecom)}</p>` : ''}
                        </div>
                    `;
                });
                
                responseDiv.innerHTML = patientsHtml + `
                    <div style="background: #e8f4f8; padding: 15px; margin: 20px 0; border-radius: 8px;">
                        <h4>Sandbox Info:</h4>
                        <p><strong>Mode:</strong> ${data.mode}</p>
                        <p><strong>Data Type:</strong> ${data.data_type}</p>
                        <p><strong>Authentication:</strong> ${data.authentication}</p>
                        <p><strong>Total Patients:</strong> ${data.total_patients}</p>
                        <p><strong>Endpoint:</strong> ${data.endpoint_used}</p>
                        <p><strong>Tenant ID:</strong> ${data.tenant_id}</p>
                    </div>
                    <details>
                        <summary>Raw FHIR Response</summary>
                        <pre>${JSON.stringify(data.raw_fhir_response, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Sandbox Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                sandboxBtn.disabled = false;
                sandboxBtn.textContent = 'Get Demo Patients';
                loading.style.display = 'none';
            }
        }

        async function fetchSandboxObservations() {
            const sandboxObsBtn = document.getElementById('sandboxObsBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                sandboxObsBtn.disabled = true;
                sandboxObsBtn.textContent = 'Fetching Demo Observations...';
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch('/oracle-sandbox/observations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode}</div>`;
                
                // Display observations summary
                let obsHtml = '<h3>Demo Observations/Vitals:</h3>';
                data.observations_summary.forEach((obs, index) => {
                    obsHtml += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; background: #f0f8ff;">
                            <h4>Observation ${index + 1}</h4>
                            <p><strong>ID:</strong> ${obs.id}</p>
                            <p><strong>Status:</strong> ${obs.status}</p>
                            <p><strong>Effective Date:</strong> ${obs.effectiveDateTime || 'N/A'}</p>
                            <p><strong>Value:</strong> ${obs.valueQuantity ? JSON.stringify(obs.valueQuantity) : obs.valueString || 'N/A'}</p>
                        </div>
                    `;
                });
                
                responseDiv.innerHTML = obsHtml + `
                    <p><strong>Total Observations:</strong> ${data.total}</p>
                    <details>
                        <summary>Raw Response</summary>
                        <pre>${JSON.stringify(data.raw_fhir_response, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                sandboxObsBtn.disabled = false;
                sandboxObsBtn.textContent = 'Get Demo Observations';
                loading.style.display = 'none';
            }
        }

        async function fetchSandboxMedications() {
            const sandboxMedsBtn = document.getElementById('sandboxMedsBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                sandboxMedsBtn.disabled = true;
                sandboxMedsBtn.textContent = 'Fetching Demo Medications...';
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch('/oracle-sandbox/medications');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode}</div>`;
                
                responseDiv.innerHTML = `
                    <h3>Demo Medications:</h3>
                    <p><strong>Total:</strong> ${data.total}</p>
                    <p><strong>Data Type:</strong> ${data.data_type}</p>
                    <pre>${JSON.stringify(data.medications_summary, null, 2)}</pre>
                    <details>
                        <summary>Raw Response</summary>
                        <pre>${JSON.stringify(data.raw_fhir_response, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                sandboxMedsBtn.disabled = false;
                sandboxMedsBtn.textContent = 'Get Demo Medications';
                loading.style.display = 'none';
            }
        }

        async function testKnownPatients() {
            const testBtn = document.getElementById('testPatientsBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                testBtn.disabled = true;
                testBtn.textContent = 'Testing Patient IDs...';
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch('/oracle-sandbox/test-known-patients');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ Testing Known Demo Patient IDs</div>`;
                
                let resultsHtml = '<h3>Test Results:</h3>';
                Object.entries(data.test_results).forEach(([patientId, result]) => {
                    const statusColor = result.status === 'found' ? '#d4edda' : '#f8d7da';
                    resultsHtml += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 5px; background: ${statusColor};">
                            <h4>Patient ID: ${patientId}</h4>
                            <p><strong>Status:</strong> ${result.status}</p>
                            ${result.status === 'found' ? `
                                <p><strong>Gender:</strong> ${result.gender || 'N/A'}</p>
                                <p><strong>Birth Date:</strong> ${result.birthDate || 'N/A'}</p>
                                <p><strong>Active:</strong> ${result.active ? 'Yes' : 'No'}</p>
                                <p><strong>Names:</strong> ${JSON.stringify(result.name)}</p>
                            ` : `
                                <p><strong>Error:</strong> ${result.error || 'Patient not found'}</p>
                            `}
                        </div>
                    `;
                });
                
                responseDiv.innerHTML = resultsHtml + `
                    <p><strong>Base URL:</strong> ${data.base_url}</p>
                    <p><strong>Note:</strong> ${data.note}</p>
                `;
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'Test Known Patient IDs';
                loading.style.display = 'none';
            }
        }

        // === ORIGINAL OAUTH FUNCTIONS ===

        async function startLogin() {
            const loginBtn = document.getElementById('loginBtn');
            const message = document.getElementById('message');
            
            try {
                loginBtn.disabled = true;
                message.innerHTML = '<div style="color: #007bff;">Getting authorization URL...</div>';
                
                // Get authorization URL from backend
                const response = await fetch('/login');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to get authorization URL');
                }
                
                const data = await response.json();
                
                // Display authorization instructions
                message.innerHTML = `
                    <div class="success">
                        <strong>Step 1:</strong> Click the link below to authorize with Oracle Health<br>
                        <strong>Step 2:</strong> After authorization, you'll be redirected back and can fetch patients<br><br>
                        <a href="${data.auth_url}" target="_blank" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                            üîó Authorize with Oracle Health
                        </a>
                    </div>
                `;
                
                // Check authorization status periodically
                checkAuthStatus();
                
            } catch (error) {
                message.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                loginBtn.disabled = false;
            }
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.has_active_token) {
                    isAuthorized = true;
                    document.getElementById('fetchPatientsBtn').disabled = false;
                    document.getElementById('loginBtn').innerHTML = '‚úÖ Authorized';
                    document.getElementById('loginBtn').disabled = true;
                    
                    const message = document.getElementById('message');
                    message.innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Authorization Complete!</strong><br>
                            You can now fetch patient data using the button below.
                        </div>
                    `;
                } else {
                    // Keep checking every 2 seconds for 30 seconds
                    setTimeout(checkAuthStatus, 2000);
                }
            } catch (error) {
                console.log('Auth check failed:', error);
            }
        }

        async function fetchPatients() {
            if (!isAuthorized) {
                const message = document.getElementById('message');
                message.innerHTML = `
                    <div class="error">
                        <strong>Authorization Required:</strong> Please complete the authorization process first.
                    </div>
                `;
                return;
            }

            const button = document.getElementById('fetchPatientsBtn');
            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            const response = document.getElementById('response');
            
            // Reset UI
            button.disabled = true;
            loading.style.display = 'block';
            message.innerHTML = '';
            response.innerHTML = '';
            
            try {
                // Make request to backend
                const result = await fetch('/patients');
                
                if (!result.ok) {
                    const errorData = await result.json();
                    if (result.status === 401) {
                        // Token expired, need to re-authorize
                        isAuthorized = false;
                        document.getElementById('fetchPatientsBtn').disabled = true;
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('loginBtn').innerHTML = 'Start Authorization';
                    }
                    throw new Error(errorData.detail || `HTTP ${result.status}: ${result.statusText}`);
                }
                
                responseData = await result.json();
                
                // Display success message
                message.innerHTML = `
                    <div class="success">
                        <strong>Success!</strong> Patients data fetched successfully from Oracle Health FHIR API.
                    </div>
                `;
                
                // Display statistics if available
                let statsHtml = '';
                if (responseData.total !== undefined) {
                    statsHtml = `
                        <div class="stats">
                            <strong>Total Patients:</strong> ${responseData.total} | 
                            <strong>Resource Type:</strong> ${responseData.resourceType || 'Bundle'} |
                            <strong>Entries:</strong> ${responseData.entry ? responseData.entry.length : 0}
                        </div>
                    `;
                }
                
                // Display JSON response
                response.innerHTML = `
                    ${statsHtml}
                    <pre>${JSON.stringify(responseData, null, 2)}</pre>
                `;
                
            } catch (error) {
                console.error('Error fetching patients:', error);
                message.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${error.message}
                        ${error.message.includes('Authorization Required') || error.message.includes('expired') ? 
                          '<br><small>Please complete the authorization process again.</small>' : ''}
                    </div>
                `;
            } finally {
                button.disabled = isAuthorized; // Re-enable only if still authorized
                loading.style.display = 'none';
            }
        }
        
        // Check if we're returning from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code') && urlParams.has('state')) {
            // We're on the callback URL, show success message
            document.addEventListener('DOMContentLoaded', function() {
                const message = document.getElementById('message');
                message.innerHTML = `
                    <div class="success">
                        <strong>Authorization successful!</strong> The callback was processed.<br>
                        You can now fetch patient data.
                    </div>
                `;
                // Check auth status
                setTimeout(checkAuthStatus, 1000);
            });
        } else {
            // Display initial message
            document.addEventListener('DOMContentLoaded', function() {
                const message = document.getElementById('message');
                message.innerHTML = `
                    <div style="text-align: center; color: #666; margin: 20px 0;">
                        <h3>Oracle Health FHIR API Integration</h3>
                        <p><strong>Step 1:</strong> Click "Start Authorization" to authenticate with Oracle Health</p>
                        <p><strong>Step 2:</strong> After authorization, use "Fetch Patients" to retrieve patient data</p>
                        <p><small>This uses OAuth2 PKCE flow for secure authentication without client secrets</small></p>
                    </div>
                `;
                
                // Check if already authorized
                checkAuthStatus();
            });
        }

        // === NEW INSURANCE AND MEDICATION FUNCTIONS ===
        
        async function fetchInsurancePlans() {
            const insuranceBtn = document.getElementById('insurancePlansBtn');
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                insuranceBtn.disabled = true;
                insuranceBtn.textContent = 'Fetching Insurance Plans...';
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                // Default to Organization/589783 as mentioned in the URL
                const response = await fetch('/oracle-sandbox/insurance-plans?owned_by=Organization/589783');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Found ${data.total_found} plans</div>`;
                
                let plansHtml = '<h3>Demo Insurance Plans:</h3>';
                data.plans_summary.forEach((plan, index) => {
                    plansHtml += `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                            <h4>Insurance Plan ${index + 1}</h4>
                            <p><strong>ID:</strong> ${plan.id}</p>
                            <p><strong>Name:</strong> ${plan.name || 'Not specified'}</p>
                            <p><strong>Status:</strong> ${plan.status || 'Not specified'}</p>
                            <p><strong>Owned By:</strong> ${JSON.stringify(plan.ownedBy)}</p>
                            <p><strong>Type:</strong> ${JSON.stringify(plan.type)}</p>
                            <p><strong>Alias:</strong> ${plan.alias.join(', ') || 'None'}</p>
                        </div>
                    `;
                });
                
                responseDiv.innerHTML = plansHtml + `
                    <details style="margin-top: 20px;">
                        <summary>Raw FHIR Response</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data.raw_fhir_response, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Insurance plans error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                insuranceBtn.disabled = false;
                insuranceBtn.textContent = 'üè• Insurance Plans';
                loading.style.display = 'none';
            }
        }
        
        async function fetchInsurancePlanById() {
            const planId = document.getElementById('insurancePlanId').value.trim();
            if (!planId) {
                alert('Please enter an Insurance Plan ID (e.g., 2798233)');
                return;
            }
            
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch(`/oracle-sandbox/insurance-plan/${planId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Plan ID: ${data.plan_id}</div>`;
                
                const planData = data.plan_data;
                let planDetailsHtml = `
                    <h3>Insurance Plan Details:</h3>
                    <div style="border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                        <h4>Plan Information</h4>
                        <p><strong>ID:</strong> ${planData.id}</p>
                        <p><strong>Name:</strong> ${planData.name || 'Not specified'}</p>
                        <p><strong>Status:</strong> ${planData.status}</p>
                        <p><strong>Resource Type:</strong> ${planData.resourceType}</p>
                        <p><strong>Owned By:</strong> ${JSON.stringify(planData.ownedBy || {})}</p>
                        <p><strong>Administered By:</strong> ${JSON.stringify(planData.administeredBy || {})}</p>
                        <p><strong>Type:</strong> ${JSON.stringify(planData.type || [])}</p>
                        <p><strong>Coverage Area:</strong> ${JSON.stringify(planData.coverageArea || [])}</p>
                    </div>
                `;
                
                responseDiv.innerHTML = planDetailsHtml + `
                    <details style="margin-top: 20px;">
                        <summary>Complete Plan Data</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(planData, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Insurance plan lookup error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function fetchMedicationRequestById() {
            const requestId = document.getElementById('medicationRequestId').value.trim();
            if (!requestId) {
                alert('Please enter a Medication Request ID (e.g., 56770371)');
                return;
            }
            
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch(`/oracle-sandbox/medication-request/${requestId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Request ID: ${data.medication_request_id}</div>`;
                
                const medSummary = data.medication_summary;
                let medDetailsHtml = `
                    <h3>Medication Request Details:</h3>
                    <div style="border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                        <h4>Medication Information</h4>
                        <p><strong>ID:</strong> ${medSummary.id}</p>
                        <p><strong>Status:</strong> ${medSummary.status}</p>
                        <p><strong>Intent:</strong> ${medSummary.intent}</p>
                        <p><strong>Authored On:</strong> ${medSummary.authoredOn || 'Not specified'}</p>
                        <p><strong>Subject:</strong> ${JSON.stringify(medSummary.subject)}</p>
                        <p><strong>Requester:</strong> ${JSON.stringify(medSummary.requester)}</p>
                        <p><strong>Medication:</strong> ${JSON.stringify(medSummary.medicationCodeableConcept)}</p>
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f0f8ff;">
                        <h4>Dosage Instructions</h4>
                        <pre>${JSON.stringify(medSummary.dosageInstruction, null, 2)}</pre>
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f0fff0;">
                        <h4>Dispense Request</h4>
                        <pre>${JSON.stringify(medSummary.dispenseRequest, null, 2)}</pre>
                    </div>
                `;
                
                responseDiv.innerHTML = medDetailsHtml + `
                    <details style="margin-top: 20px;">
                        <summary>Complete Medication Request Data</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data.raw_medication_data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Medication request lookup error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // === ENHANCED PATIENT PROFILE FUNCTIONS ===
        
        async function fetchCompletePatientProfile() {
            const patientId = document.getElementById('patientId').value.trim();
            if (!patientId) {
                alert('Please enter a Patient ID (e.g., 12724066)');
                return;
            }
            await fetchCompletePatientProfileById(patientId);
        }
        
        async function fetchCompletePatientProfileById(patientId) {
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch(`/oracle-sandbox/patient-complete/${patientId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const patient = data.patient_summary;
                const insurance = data.insurance_coverage;
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Patient ID: ${data.patient_id}</div>`;
                
                // Format addresses
                let addressHtml = '';
                if (patient.formatted_addresses && patient.formatted_addresses.length > 0) {
                    addressHtml = patient.formatted_addresses.map(addr => 
                        `<div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <strong>${addr.use}:</strong> ${addr.formatted_text}
                            ${addr.period ? `<br><small>Period: ${JSON.stringify(addr.period)}</small>` : ''}
                        </div>`
                    ).join('');
                } else {
                    addressHtml = '<p>No address information available</p>';
                }
                
                // Format contacts
                let contactHtml = '';
                if (patient.formatted_contacts && patient.formatted_contacts.length > 0) {
                    contactHtml = patient.formatted_contacts.map(contact => 
                        `<div style="margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 3px;">
                            <strong>${contact.type} (${contact.use}):</strong> ${contact.value}
                        </div>`
                    ).join('');
                } else {
                    contactHtml = '<p>No contact information available</p>';
                }
                
                // Format insurance
                let insuranceHtml = '';
                if (insurance && insurance.length > 0) {
                    insuranceHtml = insurance.map((plan, index) => 
                        `<div style="margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #007bff;">
                            <h6>Insurance Plan ${index + 1}</h6>
                            <p><strong>ID:</strong> ${plan.id}</p>
                            <p><strong>Status:</strong> ${plan.status}</p>
                            <p><strong>Subscriber ID:</strong> ${plan.subscriberId || 'Not available'}</p>
                            <p><strong>Type:</strong> ${plan.type?.text || 'Not specified'}</p>
                            <p><strong>Relationship:</strong> ${plan.relationship?.text || 'Not specified'}</p>
                            <p><strong>Period:</strong> ${plan.period?.start || 'Not specified'} to ${plan.period?.end || 'ongoing'}</p>
                            <p><strong>Payor:</strong> ${JSON.stringify(plan.payor)}</p>
                        </div>`
                    ).join('');
                } else {
                    insuranceHtml = '<div style="padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;"><p>‚ùå No insurance coverage information found for this patient</p></div>';
                }
                
                let profileHtml = `
                    <h3>Complete Patient Profile: ${patient.formatted_names.join(', ')}</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                            <h4>üìã Demographics</h4>
                            <p><strong>Patient ID:</strong> ${patient.id}</p>
                            <p><strong>Full Name:</strong> ${patient.formatted_names.join(', ') || 'Not available'}</p>
                            <p><strong>Gender:</strong> ${patient.gender || 'Not specified'}</p>
                            <p><strong>Birth Date:</strong> ${patient.birthDate || 'Not specified'}</p>
                            <p><strong>Age:</strong> ${patient.calculated_age ? patient.calculated_age + ' years old' : 'Not calculated'}</p>
                            <p><strong>Birth Year:</strong> ${patient.birth_year || 'Not available'}</p>
                            <p><strong>Active Status:</strong> ${patient.active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                            <p><strong>Marital Status:</strong> ${patient.maritalStatus?.text || 'Not specified'}</p>
                        </div>
                        
                        <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                            <h4>üìû Contact Information</h4>
                            ${contactHtml}
                        </div>
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                        <h4>üè† Address Information</h4>
                        ${addressHtml}
                    </div>
                    
                    <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f9f9f9;">
                        <h4>üè• Insurance Coverage ${data.has_insurance_data ? '(' + insurance.length + ' plans found)' : '(No coverage found)'}</h4>
                        ${insuranceHtml}
                    </div>
                `;
                
                responseDiv.innerHTML = profileHtml + `
                    <details style="margin-top: 20px;">
                        <summary>Raw Patient Data</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data.raw_patient_data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Complete patient profile error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        async function fetchPatientCoverage() {
            const patientId = document.getElementById('patientId').value.trim();
            if (!patientId) {
                alert('Please enter a Patient ID (e.g., 12724066)');
                return;
            }
            
            const loading = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const responseDiv = document.getElementById('response');
            
            try {
                loading.style.display = 'block';
                messageDiv.innerHTML = '';
                responseDiv.innerHTML = '';
                
                const response = await fetch(`/oracle-sandbox/patient-coverage/${patientId}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                messageDiv.innerHTML = `<div class="success">‚úÖ ${data.mode} - Found ${data.total_coverage_plans} coverage plans</div>`;
                
                let coverageHtml = `<h3>Insurance Coverage for Patient ${data.patient_id}:</h3>`;
                
                if (data.coverage_summaries && data.coverage_summaries.length > 0) {
                    data.coverage_summaries.forEach((coverage, index) => {
                        coverageHtml += `
                            <div style="border: 1px solid #007bff; padding: 15px; margin: 15px 0; border-radius: 8px; background: #f0f6ff;">
                                <h4>Coverage Plan ${index + 1}</h4>
                                <p><strong>Coverage ID:</strong> ${coverage.id}</p>
                                <p><strong>Status:</strong> ${coverage.status}</p>
                                <p><strong>Subscriber ID:</strong> ${coverage.subscriberId || 'Not available'}</p>
                                <p><strong>Relationship:</strong> ${coverage.relationship?.text || 'Not specified'}</p>
                                <p><strong>Order:</strong> ${coverage.order || 'Not specified'}</p>
                                <p><strong>Network:</strong> ${coverage.network || 'Not specified'}</p>
                                <div style="margin: 10px 0;">
                                    <strong>Coverage Type:</strong>
                                    <pre style="background: #e9ecef; padding: 8px; border-radius: 3px;">${JSON.stringify(coverage.type, null, 2)}</pre>
                                </div>
                                <div style="margin: 10px 0;">
                                    <strong>Payor Information:</strong>
                                    <pre style="background: #e9ecef; padding: 8px; border-radius: 3px;">${JSON.stringify(coverage.payor, null, 2)}</pre>
                                </div>
                                <div style="margin: 10px 0;">
                                    <strong>Coverage Period:</strong>
                                    <pre style="background: #e9ecef; padding: 8px; border-radius: 3px;">${JSON.stringify(coverage.period, null, 2)}</pre>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    coverageHtml += '<div style="padding: 20px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;"><p>‚ùå No insurance coverage found for this patient</p></div>';
                }
                
                responseDiv.innerHTML = coverageHtml + `
                    <details style="margin-top: 20px;">
                        <summary>Raw Coverage Data</summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data.raw_coverage_data, null, 2)}</pre>
                    </details>
                `;
                
            } catch (error) {
                console.error('Patient coverage error:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                responseDiv.innerHTML = '';
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>